FROM ubuntu:focal AS builder

RUN apt-get update && apt-get -y install \
		git \
	&& rm -rf /var/lib/apt/lists/*

ARG CONDA_ENV_REPO
ARG CONDA_ENV_REPO_HASH

RUN git clone \
	--recurse-submodules \
	"${CONDA_ENV_REPO}" \
	/opt/conda_env_repo
WORKDIR /opt/conda_env_repo
RUN git checkout "${CONDA_ENV_REPO_HASH}"


FROM continuumio/miniconda3:4.12.0

MAINTAINER Heather Ward <heather@dnastack.com>

ARG IMAGE_NAME
ENV IMAGE_NAME "${IMAGE_NAME}"
ENV CONDA_ENV "${IMAGE_NAME}"
ARG IMAGE_TAG
ENV IMAGE_TAG "${IMAGE_TAG}"

COPY --from=builder /opt/conda_env_repo/scripts /opt/scripts
COPY --from=builder "/opt/conda_env_repo/rules/envs/${CONDA_ENV}.yaml" /opt/envs/
RUN chmod +x /opt/scripts/*

RUN conda env create --file "/opt/envs/${CONDA_ENV}.yaml" --name "${CONDA_ENV}"
ENV PATH /opt/conda/envs/${CONDA_ENV}/bin:/opt/scripts:$PATH

RUN echo "source activate ${CONDA_ENV}" >> ~/.bashrc
